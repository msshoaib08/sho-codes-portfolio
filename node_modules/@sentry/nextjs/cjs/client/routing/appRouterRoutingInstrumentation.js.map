{"version":3,"file":"appRouterRoutingInstrumentation.js","sources":["../../../../src/client/routing/appRouterRoutingInstrumentation.ts"],"sourcesContent":["import {\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n} from '@sentry/core';\nimport { WINDOW, startBrowserTracingNavigationSpan, startBrowserTracingPageLoadSpan } from '@sentry/react';\nimport type { Client } from '@sentry/types';\nimport { addFetchInstrumentationHandler, browserPerformanceTimeOrigin } from '@sentry/utils';\n\n/** Instruments the Next.js app router for pageloads. */\nexport function appRouterInstrumentPageLoad(client: Client): void {\n  startBrowserTracingPageLoadSpan(client, {\n    name: WINDOW.location.pathname,\n    // pageload should always start at timeOrigin (and needs to be in s, not ms)\n    startTime: browserPerformanceTimeOrigin ? browserPerformanceTimeOrigin / 1000 : undefined,\n    attributes: {\n      [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'pageload',\n      [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.pageload.nextjs.app_router_instrumentation',\n      [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n    },\n  });\n}\n\n/** Instruments the Next.js app router for navigation. */\nexport function appRouterInstrumentNavigation(client: Client): void {\n  addFetchInstrumentationHandler(handlerData => {\n    // The instrumentation handler is invoked twice - once for starting a request and once when the req finishes\n    // We can use the existence of the end-timestamp to filter out \"finishing\"-events.\n    if (handlerData.endTimestamp !== undefined) {\n      return;\n    }\n\n    // Only GET requests can be navigating RSC requests\n    if (handlerData.fetchData.method !== 'GET') {\n      return;\n    }\n\n    const parsedNavigatingRscFetchArgs = parseNavigatingRscFetchArgs(handlerData.args);\n\n    if (parsedNavigatingRscFetchArgs === null) {\n      return;\n    }\n\n    const newPathname = parsedNavigatingRscFetchArgs.targetPathname;\n\n    startBrowserTracingNavigationSpan(client, {\n      name: newPathname,\n      attributes: {\n        [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'navigation',\n        [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.navigation.nextjs.app_router_instrumentation',\n        [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'url',\n      },\n    });\n  });\n}\n\nfunction parseNavigatingRscFetchArgs(fetchArgs: unknown[]): null | {\n  targetPathname: string;\n} {\n  // Make sure the first arg is a URL object\n  if (!fetchArgs[0] || typeof fetchArgs[0] !== 'object' || (fetchArgs[0] as URL).searchParams === undefined) {\n    return null;\n  }\n\n  // Make sure the second argument is some kind of fetch config obj that contains headers\n  if (!fetchArgs[1] || typeof fetchArgs[1] !== 'object' || !('headers' in fetchArgs[1])) {\n    return null;\n  }\n\n  try {\n    const url = fetchArgs[0] as URL;\n    const headers = fetchArgs[1].headers as Record<string, string>;\n\n    // Not an RSC request\n    if (headers['RSC'] !== '1') {\n      return null;\n    }\n\n    // Prefetch requests are not navigating RSC requests\n    if (headers['Next-Router-Prefetch'] === '1') {\n      return null;\n    }\n\n    return {\n      targetPathname: url.pathname,\n    };\n  } catch {\n    return null;\n  }\n}\n"],"names":["startBrowserTracingPageLoadSpan","WINDOW","browserPerformanceTimeOrigin","SEMANTIC_ATTRIBUTE_SENTRY_OP","SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN","SEMANTIC_ATTRIBUTE_SENTRY_SOURCE","addFetchInstrumentationHandler","startBrowserTracingNavigationSpan"],"mappings":";;;;;;AASA;AACO,SAAS,2BAA2B,CAAC,MAAM,EAAgB;AAClE,EAAEA,qCAA+B,CAAC,MAAM,EAAE;AAC1C,IAAI,IAAI,EAAEC,YAAM,CAAC,QAAQ,CAAC,QAAQ;AAClC;AACA,IAAI,SAAS,EAAEC,kCAA6B,GAAEA,qCAA+B,IAAA,GAAO,SAAS;AAC7F,IAAI,UAAU,EAAE;AAChB,MAAM,CAACC,iCAA4B,GAAG,UAAU;AAChD,MAAM,CAACC,qCAAgC,GAAG,iDAAiD;AAC3F,MAAM,CAACC,qCAAgC,GAAG,KAAK;AAC/C,KAAK;AACL,GAAG,CAAC,CAAA;AACJ,CAAA;AACA;AACA;AACO,SAAS,6BAA6B,CAAC,MAAM,EAAgB;AACpE,EAAEC,oCAA8B,CAAC,WAAA,IAAe;AAChD;AACA;AACA,IAAI,IAAI,WAAW,CAAC,YAAa,KAAI,SAAS,EAAE;AAChD,MAAM,OAAM;AACZ,KAAI;AACJ;AACA;AACA,IAAI,IAAI,WAAW,CAAC,SAAS,CAAC,MAAA,KAAW,KAAK,EAAE;AAChD,MAAM,OAAM;AACZ,KAAI;AACJ;AACA,IAAI,MAAM,+BAA+B,2BAA2B,CAAC,WAAW,CAAC,IAAI,CAAC,CAAA;AACtF;AACA,IAAI,IAAI,4BAA6B,KAAI,IAAI,EAAE;AAC/C,MAAM,OAAM;AACZ,KAAI;AACJ;AACA,IAAI,MAAM,WAAA,GAAc,4BAA4B,CAAC,cAAc,CAAA;AACnE;AACA,IAAIC,uCAAiC,CAAC,MAAM,EAAE;AAC9C,MAAM,IAAI,EAAE,WAAW;AACvB,MAAM,UAAU,EAAE;AAClB,QAAQ,CAACJ,iCAA4B,GAAG,YAAY;AACpD,QAAQ,CAACC,qCAAgC,GAAG,mDAAmD;AAC/F,QAAQ,CAACC,qCAAgC,GAAG,KAAK;AACjD,OAAO;AACP,KAAK,CAAC,CAAA;AACN,GAAG,CAAC,CAAA;AACJ,CAAA;AACA;AACA,SAAS,2BAA2B,CAAC,SAAS;AAC5C;AACF,CAAE;AACF;AACA,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAA,IAAK,OAAO,SAAS,CAAC,CAAC,CAAA,KAAM,QAAS,IAAG,CAAC,SAAS,CAAC,CAAC,CAAE,GAAQ,YAAA,KAAiB,SAAS,EAAE;AAC7G,IAAI,OAAO,IAAI,CAAA;AACf,GAAE;AACF;AACA;AACA,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC,CAAE,IAAG,OAAO,SAAS,CAAC,CAAC,MAAM,QAAA,IAAY,EAAE,SAAA,IAAa,SAAS,CAAC,CAAC,CAAC,CAAC,EAAE;AACzF,IAAI,OAAO,IAAI,CAAA;AACf,GAAE;AACF;AACA,EAAE,IAAI;AACN,IAAI,MAAM,GAAI,GAAE,SAAS,CAAC,CAAC,CAAE,EAAA;AAC7B,IAAI,MAAM,UAAU,SAAS,CAAC,CAAC,CAAC,CAAC,OAAQ,EAAA;AACzC;AACA;AACA,IAAI,IAAI,OAAO,CAAC,KAAK,CAAE,KAAI,GAAG,EAAE;AAChC,MAAM,OAAO,IAAI,CAAA;AACjB,KAAI;AACJ;AACA;AACA,IAAI,IAAI,OAAO,CAAC,sBAAsB,CAAE,KAAI,GAAG,EAAE;AACjD,MAAM,OAAO,IAAI,CAAA;AACjB,KAAI;AACJ;AACA,IAAI,OAAO;AACX,MAAM,cAAc,EAAE,GAAG,CAAC,QAAQ;AAClC,KAAK,CAAA;AACL,IAAI,OAAM,CAAA,EAAA;AACV,IAAI,OAAO,IAAI,CAAA;AACf,GAAE;AACF;;;;;"}