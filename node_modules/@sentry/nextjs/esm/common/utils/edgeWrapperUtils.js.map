{"version":3,"file":"edgeWrapperUtils.js","sources":["../../../../src/common/utils/edgeWrapperUtils.ts"],"sourcesContent":["import {\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  SPAN_STATUS_OK,\n  captureException,\n  continueTrace,\n  handleCallbackErrors,\n  setHttpStatus,\n  startSpan,\n  withIsolationScope,\n} from '@sentry/core';\nimport { winterCGRequestToRequestData } from '@sentry/utils';\n\nimport type { EdgeRouteHandler } from '../../edge/types';\nimport { flushQueue } from './responseEnd';\nimport { commonObjectToIsolationScope, escapeNextjsTracing } from './tracingUtils';\n\n/**\n * Wraps a function on the edge runtime with error and performance monitoring.\n */\nexport function withEdgeWrapping<H extends EdgeRouteHandler>(\n  handler: H,\n  options: { spanDescription: string; spanOp: string; mechanismFunctionName: string },\n): (...params: Parameters<H>) => Promise<ReturnType<H>> {\n  return async function (this: unknown, ...args) {\n    return escapeNextjsTracing(() => {\n      const req: unknown = args[0];\n      return withIsolationScope(commonObjectToIsolationScope(req), isolationScope => {\n        let sentryTrace;\n        let baggage;\n\n        if (req instanceof Request) {\n          sentryTrace = req.headers.get('sentry-trace') || '';\n          baggage = req.headers.get('baggage');\n\n          isolationScope.setSDKProcessingMetadata({\n            request: winterCGRequestToRequestData(req),\n          });\n        }\n\n        isolationScope.setTransactionName(options.spanDescription);\n\n        return continueTrace(\n          {\n            sentryTrace,\n            baggage,\n          },\n          () => {\n            return startSpan(\n              {\n                name: options.spanDescription,\n                op: options.spanOp,\n                forceTransaction: true,\n                attributes: {\n                  [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'route',\n                  [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.function.nextjs.withEdgeWrapping',\n                },\n              },\n              async span => {\n                const handlerResult = await handleCallbackErrors(\n                  () => handler.apply(this, args),\n                  error => {\n                    captureException(error, {\n                      mechanism: {\n                        type: 'instrument',\n                        handled: false,\n                        data: {\n                          function: options.mechanismFunctionName,\n                        },\n                      },\n                    });\n                  },\n                );\n\n                if (handlerResult instanceof Response) {\n                  setHttpStatus(span, handlerResult.status);\n                } else {\n                  span.setStatus({ code: SPAN_STATUS_OK });\n                }\n\n                return handlerResult;\n              },\n            ).finally(() => flushQueue());\n          },\n        );\n      });\n    });\n  };\n}\n"],"names":[],"mappings":";;;;;AAiBA;AACA;AACA;AACO,SAAS,gBAAgB;AAChC,EAAE,OAAO;AACT,EAAE,OAAO;AACT,EAAwD;AACxD,EAAE,OAAO,iBAA+B,GAAG,IAAI,EAAE;AACjD,IAAI,OAAO,mBAAmB,CAAC,MAAM;AACrC,MAAM,MAAM,GAAG,GAAY,IAAI,CAAC,CAAC,CAAC,CAAA;AAClC,MAAM,OAAO,kBAAkB,CAAC,4BAA4B,CAAC,GAAG,CAAC,EAAE,cAAA,IAAkB;AACrF,QAAQ,IAAI,WAAW,CAAA;AACvB,QAAQ,IAAI,OAAO,CAAA;AACnB;AACA,QAAQ,IAAI,GAAI,YAAW,OAAO,EAAE;AACpC,UAAU,WAAA,GAAc,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAE,IAAG,EAAE,CAAA;AAC7D,UAAU,OAAA,GAAU,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAA;AAC9C;AACA,UAAU,cAAc,CAAC,wBAAwB,CAAC;AAClD,YAAY,OAAO,EAAE,4BAA4B,CAAC,GAAG,CAAC;AACtD,WAAW,CAAC,CAAA;AACZ,SAAQ;AACR;AACA,QAAQ,cAAc,CAAC,kBAAkB,CAAC,OAAO,CAAC,eAAe,CAAC,CAAA;AAClE;AACA,QAAQ,OAAO,aAAa;AAC5B,UAAU;AACV,YAAY,WAAW;AACvB,YAAY,OAAO;AACnB,WAAW;AACX,UAAU,MAAM;AAChB,YAAY,OAAO,SAAS;AAC5B,cAAc;AACd,gBAAgB,IAAI,EAAE,OAAO,CAAC,eAAe;AAC7C,gBAAgB,EAAE,EAAE,OAAO,CAAC,MAAM;AAClC,gBAAgB,gBAAgB,EAAE,IAAI;AACtC,gBAAgB,UAAU,EAAE;AAC5B,kBAAkB,CAAC,gCAAgC,GAAG,OAAO;AAC7D,kBAAkB,CAAC,gCAAgC,GAAG,uCAAuC;AAC7F,iBAAiB;AACjB,eAAe;AACf,cAAc,MAAM,QAAQ;AAC5B,gBAAgB,MAAM,aAAA,GAAgB,MAAM,oBAAoB;AAChE,kBAAkB,MAAM,OAAO,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC;AACjD,kBAAkB,SAAS;AAC3B,oBAAoB,gBAAgB,CAAC,KAAK,EAAE;AAC5C,sBAAsB,SAAS,EAAE;AACjC,wBAAwB,IAAI,EAAE,YAAY;AAC1C,wBAAwB,OAAO,EAAE,KAAK;AACtC,wBAAwB,IAAI,EAAE;AAC9B,0BAA0B,QAAQ,EAAE,OAAO,CAAC,qBAAqB;AACjE,yBAAyB;AACzB,uBAAuB;AACvB,qBAAqB,CAAC,CAAA;AACtB,mBAAmB;AACnB,iBAAiB,CAAA;AACjB;AACA,gBAAgB,IAAI,aAAc,YAAW,QAAQ,EAAE;AACvD,kBAAkB,aAAa,CAAC,IAAI,EAAE,aAAa,CAAC,MAAM,CAAC,CAAA;AAC3D,uBAAuB;AACvB,kBAAkB,IAAI,CAAC,SAAS,CAAC,EAAE,IAAI,EAAE,cAAe,EAAC,CAAC,CAAA;AAC1D,iBAAgB;AAChB;AACA,gBAAgB,OAAO,aAAa,CAAA;AACpC,eAAe;AACf,aAAa,CAAC,OAAO,CAAC,MAAM,UAAU,EAAE,CAAC,CAAA;AACzC,WAAW;AACX,SAAS,CAAA;AACT,OAAO,CAAC,CAAA;AACR,KAAK,CAAC,CAAA;AACN,GAAG,CAAA;AACH;;;;"}