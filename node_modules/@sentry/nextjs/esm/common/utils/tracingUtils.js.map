{"version":3,"file":"tracingUtils.js","sources":["../../../../src/common/utils/tracingUtils.ts"],"sourcesContent":["import { Scope, getCurrentScope, withActiveSpan } from '@sentry/core';\nimport type { PropagationContext } from '@sentry/types';\nimport { GLOBAL_OBJ, logger, uuid4 } from '@sentry/utils';\nimport { DEBUG_BUILD } from '../debug-build';\n\nconst commonPropagationContextMap = new WeakMap<object, PropagationContext>();\n\n/**\n * Takes a shared (garbage collectable) object between resources, e.g. a headers object shared between Next.js server components and returns a common propagation context.\n *\n * @param commonObject The shared object.\n * @param propagationContext The propagation context that should be shared between all the resources if no propagation context was registered yet.\n * @returns the shared propagation context.\n */\nexport function commonObjectToPropagationContext(\n  commonObject: unknown,\n  propagationContext: PropagationContext,\n): PropagationContext {\n  if (typeof commonObject === 'object' && commonObject) {\n    const memoPropagationContext = commonPropagationContextMap.get(commonObject);\n    if (memoPropagationContext) {\n      return memoPropagationContext;\n    } else {\n      commonPropagationContextMap.set(commonObject, propagationContext);\n      return propagationContext;\n    }\n  } else {\n    return propagationContext;\n  }\n}\n\nconst commonIsolationScopeMap = new WeakMap<object, Scope>();\n\n/**\n * Takes a shared (garbage collectable) object between resources, e.g. a headers object shared between Next.js server components and returns a common propagation context.\n *\n * @param commonObject The shared object.\n * @param isolationScope The isolationScope that should be shared between all the resources if no isolation scope was created yet.\n * @returns the shared isolation scope.\n */\nexport function commonObjectToIsolationScope(commonObject: unknown): Scope {\n  if (typeof commonObject === 'object' && commonObject) {\n    const memoIsolationScope = commonIsolationScopeMap.get(commonObject);\n    if (memoIsolationScope) {\n      return memoIsolationScope;\n    } else {\n      const newIsolationScope = new Scope();\n      commonIsolationScopeMap.set(commonObject, newIsolationScope);\n      return newIsolationScope;\n    }\n  } else {\n    return new Scope();\n  }\n}\n\ninterface AsyncLocalStorage<T> {\n  getStore(): T | undefined;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  run<R, TArgs extends any[]>(store: T, callback: (...args: TArgs) => R, ...args: TArgs): R;\n}\n\nlet nextjsEscapedAsyncStorage: AsyncLocalStorage<true>;\n\n/**\n * Will mark the execution context of the callback as \"escaped\" from Next.js internal tracing by unsetting the active\n * span and propagation context. When an execution passes through this function multiple times, it is a noop after the\n * first time.\n */\nexport function escapeNextjsTracing<T>(cb: () => T): T {\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-explicit-any\n  const MaybeGlobalAsyncLocalStorage = (GLOBAL_OBJ as any).AsyncLocalStorage;\n\n  if (!MaybeGlobalAsyncLocalStorage) {\n    DEBUG_BUILD &&\n      logger.warn(\n        \"Tried to register AsyncLocalStorage async context strategy in a runtime that doesn't support AsyncLocalStorage.\",\n      );\n    return cb();\n  }\n\n  if (!nextjsEscapedAsyncStorage) {\n    nextjsEscapedAsyncStorage = new MaybeGlobalAsyncLocalStorage();\n  }\n\n  if (nextjsEscapedAsyncStorage.getStore()) {\n    return cb();\n  } else {\n    return withActiveSpan(null, () => {\n      getCurrentScope().setPropagationContext({\n        traceId: uuid4(),\n        spanId: uuid4().substring(16),\n      });\n      return nextjsEscapedAsyncStorage.run(true, () => {\n        return cb();\n      });\n    });\n  }\n}\n"],"names":[],"mappings":";;;;AAKA,MAAM,2BAA4B,GAAE,IAAI,OAAO,EAA8B,CAAA;AAC7E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,gCAAgC;AAChD,EAAE,YAAY;AACd,EAAE,kBAAkB;AACpB,EAAsB;AACtB,EAAE,IAAI,OAAO,YAAA,KAAiB,QAAS,IAAG,YAAY,EAAE;AACxD,IAAI,MAAM,yBAAyB,2BAA2B,CAAC,GAAG,CAAC,YAAY,CAAC,CAAA;AAChF,IAAI,IAAI,sBAAsB,EAAE;AAChC,MAAM,OAAO,sBAAsB,CAAA;AACnC,WAAW;AACX,MAAM,2BAA2B,CAAC,GAAG,CAAC,YAAY,EAAE,kBAAkB,CAAC,CAAA;AACvE,MAAM,OAAO,kBAAkB,CAAA;AAC/B,KAAI;AACJ,SAAS;AACT,IAAI,OAAO,kBAAkB,CAAA;AAC7B,GAAE;AACF,CAAA;AACA;AACA,MAAM,uBAAwB,GAAE,IAAI,OAAO,EAAiB,CAAA;AAC5D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,4BAA4B,CAAC,YAAY,EAAkB;AAC3E,EAAE,IAAI,OAAO,YAAA,KAAiB,QAAS,IAAG,YAAY,EAAE;AACxD,IAAI,MAAM,qBAAqB,uBAAuB,CAAC,GAAG,CAAC,YAAY,CAAC,CAAA;AACxE,IAAI,IAAI,kBAAkB,EAAE;AAC5B,MAAM,OAAO,kBAAkB,CAAA;AAC/B,WAAW;AACX,MAAM,MAAM,iBAAkB,GAAE,IAAI,KAAK,EAAE,CAAA;AAC3C,MAAM,uBAAuB,CAAC,GAAG,CAAC,YAAY,EAAE,iBAAiB,CAAC,CAAA;AAClE,MAAM,OAAO,iBAAiB,CAAA;AAC9B,KAAI;AACJ,SAAS;AACT,IAAI,OAAO,IAAI,KAAK,EAAE,CAAA;AACtB,GAAE;AACF,CAAA;;AAQA,IAAI,yBAAyB,CAAA;AAC7B;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,mBAAmB,CAAI,EAAE,EAAc;AACvD;AACA,EAAE,MAAM,4BAA6B,GAAE,CAAC,UAAW,GAAQ,iBAAiB,CAAA;AAC5E;AACA,EAAE,IAAI,CAAC,4BAA4B,EAAE;AACrC,IAAI,WAAY;AAChB,MAAM,MAAM,CAAC,IAAI;AACjB,QAAQ,iHAAiH;AACzH,OAAO,CAAA;AACP,IAAI,OAAO,EAAE,EAAE,CAAA;AACf,GAAE;AACF;AACA,EAAE,IAAI,CAAC,yBAAyB,EAAE;AAClC,IAAI,yBAA0B,GAAE,IAAI,4BAA4B,EAAE,CAAA;AAClE,GAAE;AACF;AACA,EAAE,IAAI,yBAAyB,CAAC,QAAQ,EAAE,EAAE;AAC5C,IAAI,OAAO,EAAE,EAAE,CAAA;AACf,SAAS;AACT,IAAI,OAAO,cAAc,CAAC,IAAI,EAAE,MAAM;AACtC,MAAM,eAAe,EAAE,CAAC,qBAAqB,CAAC;AAC9C,QAAQ,OAAO,EAAE,KAAK,EAAE;AACxB,QAAQ,MAAM,EAAE,KAAK,EAAE,CAAC,SAAS,CAAC,EAAE,CAAC;AACrC,OAAO,CAAC,CAAA;AACR,MAAM,OAAO,yBAAyB,CAAC,GAAG,CAAC,IAAI,EAAE,MAAM;AACvD,QAAQ,OAAO,EAAE,EAAE,CAAA;AACnB,OAAO,CAAC,CAAA;AACR,KAAK,CAAC,CAAA;AACN,GAAE;AACF;;;;"}