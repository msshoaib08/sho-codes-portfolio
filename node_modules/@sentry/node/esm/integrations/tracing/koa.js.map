{"version":3,"file":"koa.js","sources":["../../../../src/integrations/tracing/koa.ts"],"sourcesContent":["import { KoaInstrumentation } from '@opentelemetry/instrumentation-koa';\nimport { SEMATTRS_HTTP_ROUTE } from '@opentelemetry/semantic-conventions';\nimport {\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  captureException,\n  defineIntegration,\n  getDefaultIsolationScope,\n  getIsolationScope,\n  spanToJSON,\n} from '@sentry/core';\nimport { addOpenTelemetryInstrumentation } from '@sentry/opentelemetry';\nimport type { IntegrationFn, Span } from '@sentry/types';\nimport { logger } from '@sentry/utils';\nimport { DEBUG_BUILD } from '../../debug-build';\nimport { ensureIsWrapped } from '../../utils/ensureIsWrapped';\n\nfunction addKoaSpanAttributes(span: Span): void {\n  span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN, 'auto.http.otel.koa');\n\n  const attributes = spanToJSON(span).data || {};\n\n  // this is one of: middleware, router\n  const type = attributes['koa.type'];\n\n  if (type) {\n    span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_OP, `${type}.koa`);\n  }\n\n  // Also update the name\n  const name = attributes['koa.name'];\n  if (typeof name === 'string') {\n    // Somehow, name is sometimes `''` for middleware spans\n    // See: https://github.com/open-telemetry/opentelemetry-js-contrib/issues/2220\n    span.updateName(name || '< unknown >');\n  }\n}\n\nconst _koaIntegration = (() => {\n  return {\n    name: 'Koa',\n    setupOnce() {\n      addOpenTelemetryInstrumentation(\n        new KoaInstrumentation({\n          requestHook(span, info) {\n            addKoaSpanAttributes(span);\n\n            if (getIsolationScope() === getDefaultIsolationScope()) {\n              DEBUG_BUILD &&\n                logger.warn('Isolation scope is default isolation scope - skipping setting transactionName');\n              return;\n            }\n            const attributes = spanToJSON(span).data;\n            const route = attributes && attributes[SEMATTRS_HTTP_ROUTE];\n            const method = info.context.request.method.toUpperCase() || 'GET';\n            if (route) {\n              getIsolationScope().setTransactionName(`${method} ${route}`);\n            }\n          },\n        }),\n      );\n    },\n  };\n}) satisfies IntegrationFn;\n\nexport const koaIntegration = defineIntegration(_koaIntegration);\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport const setupKoaErrorHandler = (app: { use: (arg0: (ctx: any, next: any) => Promise<void>) => void }): void => {\n  app.use(async (ctx, next) => {\n    try {\n      await next();\n    } catch (error) {\n      captureException(error);\n    }\n  });\n\n  ensureIsWrapped(app.use, 'koa');\n};\n"],"names":[],"mappings":";;;;;;;;AAiBA,SAAS,oBAAoB,CAAC,IAAI,EAAc;AAChD,EAAE,IAAI,CAAC,YAAY,CAAC,gCAAgC,EAAE,oBAAoB,CAAC,CAAA;AAC3E;AACA,EAAE,MAAM,UAAW,GAAE,UAAU,CAAC,IAAI,CAAC,CAAC,IAAA,IAAQ,EAAE,CAAA;AAChD;AACA;AACA,EAAE,MAAM,IAAK,GAAE,UAAU,CAAC,UAAU,CAAC,CAAA;AACrC;AACA,EAAE,IAAI,IAAI,EAAE;AACZ,IAAI,IAAI,CAAC,YAAY,CAAC,4BAA4B,EAAE,CAAC,EAAA,IAAA,CAAA,IAAA,CAAA,CAAA,CAAA;AACA,GAAA;AACA;AACA;AACA,EAAA,MAAA,IAAA,GAAA,UAAA,CAAA,UAAA,CAAA,CAAA;AACA,EAAA,IAAA,OAAA,IAAA,KAAA,QAAA,EAAA;AACA;AACA;AACA,IAAA,IAAA,CAAA,UAAA,CAAA,IAAA,IAAA,aAAA,CAAA,CAAA;AACA,GAAA;AACA,CAAA;AACA;AACA,MAAA,eAAA,IAAA,MAAA;AACA,EAAA,OAAA;AACA,IAAA,IAAA,EAAA,KAAA;AACA,IAAA,SAAA,GAAA;AACA,MAAA,+BAAA;AACA,QAAA,IAAA,kBAAA,CAAA;AACA,UAAA,WAAA,CAAA,IAAA,EAAA,IAAA,EAAA;AACA,YAAA,oBAAA,CAAA,IAAA,CAAA,CAAA;AACA;AACA,YAAA,IAAA,iBAAA,EAAA,KAAA,wBAAA,EAAA,EAAA;AACA,cAAA,WAAA;AACA,gBAAA,MAAA,CAAA,IAAA,CAAA,+EAAA,CAAA,CAAA;AACA,cAAA,OAAA;AACA,aAAA;AACA,YAAA,MAAA,UAAA,GAAA,UAAA,CAAA,IAAA,CAAA,CAAA,IAAA,CAAA;AACA,YAAA,MAAA,KAAA,GAAA,UAAA,IAAA,UAAA,CAAA,mBAAA,CAAA,CAAA;AACA,YAAA,MAAA,MAAA,GAAA,IAAA,CAAA,OAAA,CAAA,OAAA,CAAA,MAAA,CAAA,WAAA,EAAA,IAAA,KAAA,CAAA;AACA,YAAA,IAAA,KAAA,EAAA;AACA,cAAA,iBAAA,EAAA,CAAA,kBAAA,CAAA,CAAA,EAAA,MAAA,CAAA,CAAA,EAAA,KAAA,CAAA,CAAA,CAAA,CAAA;AACA,aAAA;AACA,WAAA;AACA,SAAA,CAAA;AACA,OAAA,CAAA;AACA,KAAA;AACA,GAAA,CAAA;AACA,CAAA,CAAA,EAAA;AACA;AACA,MAAA,cAAA,GAAA,iBAAA,CAAA,eAAA,EAAA;AACA;AACA;AACA,MAAA,oBAAA,GAAA,CAAA,GAAA,KAAA;AACA,EAAA,GAAA,CAAA,GAAA,CAAA,OAAA,GAAA,EAAA,IAAA,KAAA;AACA,IAAA,IAAA;AACA,MAAA,MAAA,IAAA,EAAA,CAAA;AACA,KAAA,CAAA,OAAA,KAAA,EAAA;AACA,MAAA,gBAAA,CAAA,KAAA,CAAA,CAAA;AACA,KAAA;AACA,GAAA,CAAA,CAAA;AACA;AACA,EAAA,eAAA,CAAA,GAAA,CAAA,GAAA,EAAA,KAAA,CAAA,CAAA;AACA;;;;"}