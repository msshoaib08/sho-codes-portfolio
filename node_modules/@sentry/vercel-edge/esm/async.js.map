{"version":3,"file":"async.js","sources":["../../src/async.ts"],"sourcesContent":["import { getDefaultCurrentScope, getDefaultIsolationScope, setAsyncContextStrategy } from '@sentry/core';\nimport type { Scope } from '@sentry/types';\nimport { GLOBAL_OBJ, logger } from '@sentry/utils';\n\nimport { DEBUG_BUILD } from './debug-build';\n\ninterface AsyncLocalStorage<T> {\n  getStore(): T | undefined;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  run<R, TArgs extends any[]>(store: T, callback: (...args: TArgs) => R, ...args: TArgs): R;\n}\n\nlet asyncStorage: AsyncLocalStorage<{ scope: Scope; isolationScope: Scope }>;\n\n/**\n * Sets the async context strategy to use AsyncLocalStorage which should be available in the edge runtime.\n */\nexport function setAsyncLocalStorageAsyncContextStrategy(): void {\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-explicit-any\n  const MaybeGlobalAsyncLocalStorage = (GLOBAL_OBJ as any).AsyncLocalStorage;\n\n  if (!MaybeGlobalAsyncLocalStorage) {\n    DEBUG_BUILD &&\n      logger.warn(\n        \"Tried to register AsyncLocalStorage async context strategy in a runtime that doesn't support AsyncLocalStorage.\",\n      );\n    return;\n  }\n\n  if (!asyncStorage) {\n    asyncStorage = new MaybeGlobalAsyncLocalStorage();\n  }\n\n  function getScopes(): { scope: Scope; isolationScope: Scope } {\n    const scopes = asyncStorage.getStore();\n\n    if (scopes) {\n      return scopes;\n    }\n\n    // fallback behavior:\n    // if, for whatever reason, we can't find scopes on the context here, we have to fix this somehow\n    return {\n      scope: getDefaultCurrentScope(),\n      isolationScope: getDefaultIsolationScope(),\n    };\n  }\n\n  function withScope<T>(callback: (scope: Scope) => T): T {\n    const scope = getScopes().scope.clone();\n    const isolationScope = getScopes().isolationScope;\n    return asyncStorage.run({ scope, isolationScope }, () => {\n      return callback(scope);\n    });\n  }\n\n  function withSetScope<T>(scope: Scope, callback: (scope: Scope) => T): T {\n    const isolationScope = getScopes().isolationScope.clone();\n    return asyncStorage.run({ scope, isolationScope }, () => {\n      return callback(scope);\n    });\n  }\n\n  function withIsolationScope<T>(callback: (isolationScope: Scope) => T): T {\n    const scope = getScopes().scope;\n    const isolationScope = getScopes().isolationScope.clone();\n    return asyncStorage.run({ scope, isolationScope }, () => {\n      return callback(isolationScope);\n    });\n  }\n\n  function withSetIsolationScope<T>(isolationScope: Scope, callback: (isolationScope: Scope) => T): T {\n    const scope = getScopes().scope;\n    return asyncStorage.run({ scope, isolationScope }, () => {\n      return callback(isolationScope);\n    });\n  }\n\n  setAsyncContextStrategy({\n    withScope,\n    withSetScope,\n    withIsolationScope,\n    withSetIsolationScope,\n    getCurrentScope: () => getScopes().scope,\n    getIsolationScope: () => getScopes().isolationScope,\n  });\n}\n"],"names":[],"mappings":";;;;AAYA,IAAI,YAAY,CAAA;AAChB;AACA;AACA;AACA;AACO,SAAS,wCAAwC,GAAS;AACjE;AACA,EAAE,MAAM,4BAA6B,GAAE,CAAC,UAAW,GAAQ,iBAAiB,CAAA;AAC5E;AACA,EAAE,IAAI,CAAC,4BAA4B,EAAE;AACrC,IAAI,WAAY;AAChB,MAAM,MAAM,CAAC,IAAI;AACjB,QAAQ,iHAAiH;AACzH,OAAO,CAAA;AACP,IAAI,OAAM;AACV,GAAE;AACF;AACA,EAAE,IAAI,CAAC,YAAY,EAAE;AACrB,IAAI,YAAa,GAAE,IAAI,4BAA4B,EAAE,CAAA;AACrD,GAAE;AACF;AACA,EAAE,SAAS,SAAS,GAA4C;AAChE,IAAI,MAAM,MAAO,GAAE,YAAY,CAAC,QAAQ,EAAE,CAAA;AAC1C;AACA,IAAI,IAAI,MAAM,EAAE;AAChB,MAAM,OAAO,MAAM,CAAA;AACnB,KAAI;AACJ;AACA;AACA;AACA,IAAI,OAAO;AACX,MAAM,KAAK,EAAE,sBAAsB,EAAE;AACrC,MAAM,cAAc,EAAE,wBAAwB,EAAE;AAChD,KAAK,CAAA;AACL,GAAE;AACF;AACA,EAAE,SAAS,SAAS,CAAI,QAAQ,EAA0B;AAC1D,IAAI,MAAM,KAAM,GAAE,SAAS,EAAE,CAAC,KAAK,CAAC,KAAK,EAAE,CAAA;AAC3C,IAAI,MAAM,cAAe,GAAE,SAAS,EAAE,CAAC,cAAc,CAAA;AACrD,IAAI,OAAO,YAAY,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,cAAe,EAAC,EAAE,MAAM;AAC7D,MAAM,OAAO,QAAQ,CAAC,KAAK,CAAC,CAAA;AAC5B,KAAK,CAAC,CAAA;AACN,GAAE;AACF;AACA,EAAE,SAAS,YAAY,CAAI,KAAK,EAAS,QAAQ,EAA0B;AAC3E,IAAI,MAAM,cAAe,GAAE,SAAS,EAAE,CAAC,cAAc,CAAC,KAAK,EAAE,CAAA;AAC7D,IAAI,OAAO,YAAY,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,cAAe,EAAC,EAAE,MAAM;AAC7D,MAAM,OAAO,QAAQ,CAAC,KAAK,CAAC,CAAA;AAC5B,KAAK,CAAC,CAAA;AACN,GAAE;AACF;AACA,EAAE,SAAS,kBAAkB,CAAI,QAAQ,EAAmC;AAC5E,IAAI,MAAM,KAAM,GAAE,SAAS,EAAE,CAAC,KAAK,CAAA;AACnC,IAAI,MAAM,cAAe,GAAE,SAAS,EAAE,CAAC,cAAc,CAAC,KAAK,EAAE,CAAA;AAC7D,IAAI,OAAO,YAAY,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,cAAe,EAAC,EAAE,MAAM;AAC7D,MAAM,OAAO,QAAQ,CAAC,cAAc,CAAC,CAAA;AACrC,KAAK,CAAC,CAAA;AACN,GAAE;AACF;AACA,EAAE,SAAS,qBAAqB,CAAI,cAAc,EAAS,QAAQ,EAAmC;AACtG,IAAI,MAAM,KAAM,GAAE,SAAS,EAAE,CAAC,KAAK,CAAA;AACnC,IAAI,OAAO,YAAY,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,cAAe,EAAC,EAAE,MAAM;AAC7D,MAAM,OAAO,QAAQ,CAAC,cAAc,CAAC,CAAA;AACrC,KAAK,CAAC,CAAA;AACN,GAAE;AACF;AACA,EAAE,uBAAuB,CAAC;AAC1B,IAAI,SAAS;AACb,IAAI,YAAY;AAChB,IAAI,kBAAkB;AACtB,IAAI,qBAAqB;AACzB,IAAI,eAAe,EAAE,MAAM,SAAS,EAAE,CAAC,KAAK;AAC5C,IAAI,iBAAiB,EAAE,MAAM,SAAS,EAAE,CAAC,cAAc;AACvD,GAAG,CAAC,CAAA;AACJ;;;;"}